<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — Products (API)</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        // --- Access control ---
        const userType = localStorage.getItem("userType");

        if (!userType || userType.toLowerCase() !== "admin") {
            // Redirect non-admin users
            window.location.href = "/index.html";  // or login page or home page
        }
    </script>
    <link rel="stylesheet" href="CSS/index.css" />
    <style>
        /* Fix for dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
            cursor: pointer;
            min-width: 150px;
            padding: 10px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

            .dropdown:hover {
                border-color: var(--primary);
            }

            .dropdown.open {
                border-color: var(--primary);
            }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-menu .opt {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

            .dropdown-menu .opt:hover {
                background-color: var(--hover-bg);
            }

            .dropdown-menu .opt.selected {
                background-color: var(--primary-light);
                color: var(--primary);
            }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

            .filter label {
                font-size: 13px;
                color: var(--muted);
                font-weight: 500;
            }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

            .loading-spinner.show {
                display: flex;
            }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

            .notification.show {
                opacity: 1;
                transform: translateX(0);
            }

            .notification.success {
                background-color: #4CAF50;
            }

            .notification.error {
                background-color: #f44336;
            }

        /* Button styles */
        .btn-icon {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            margin-left: 4px;
            transition: all 0.2s;
        }

            .btn-icon:hover {
                background-color: var(--hover-bg);
                border-color: var(--primary);
            }

        /* Modal styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

            .overlay.show {
                opacity: 1;
            }

        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }

        .overlay.show .modal {
            transform: translateY(0);
        }

        .view-modal .view-content {
            display: flex;
            gap: 30px;
            margin: 20px 0;
        }

        .view-modal .image-section {
            flex: 0 0 300px;
        }

        .view-modal .details-section {
            flex: 1;
        }

        .view-modal .product-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .view-modal .product-description {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .view-modal .product-price {
            font-size: 20px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .view-modal .product-brand,
        .view-modal .product-category,
        .view-modal .product-year {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

            .thumbnail:hover,
            .thumbnail.selected {
                border-color: var(--primary);
            }

        .thumbnails-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .main-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-chart-line"></i> <span>AdminPanel</span></h2>
        </div>

        <div class="sidebar-menu">
            <ul>
                <li><a href="admin.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li class="active"><a href="AdminProducts.html"><i class="fas fa-box"></i> <span>Products</span></a></li>
                <li><a href="AdminCategory.html"><i class="fas fa-tags"></i> <span>Categories</span></a></li>
                <li><a href="AdminBrands.html"><i class="fas fa-star"></i> <span>Brands</span></a></li>
                <li><a href="AdminOrders.html"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                <li><a href="AdminDropshipper.html"><i class="fas fa-users"></i> <span>Customers</span></a></li>
                <li><a href="#"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
        </div>
    </div>

    <!-- MAIN WRAPPER -->
    <div class="main">

        <!-- HEADER -->
        <header class="header">
            <div class="header-left">
                <h1>Products — Admin</h1>
                <div class="muted" style="font-size:13px;margin-top:6px;">Search & manage products (API-driven)</div>
            </div>

            <div class="header-right">
                <div class="search" title="Search">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-4.35-4.35"></path><circle cx="11" cy="11" r="6"></circle></svg>
                    <input id="searchInput" placeholder="Search term (e.g. tablet)" />
                </div>

                <button id="addProductBtn" class="btn">+ Add</button>

                <div class="user-profile" style="margin-left:8px;">
                    <div class="user-avatar">M</div>
                    <div class="muted" style="font-size:14px;">Mohamed</div>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            <div class="container">

                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
                    <div>
                        <h1 style="margin:0;">Products</h1>
                        <div class="muted">Search & manage products (API-driven)</div>
                    </div>
                    <div style="display:flex;gap:12px;align-items:center">
                        <!-- optional top actions -->
                    </div>
                </div>

                <div class="filters" style="margin-top:16px;">
                    <div class="filter">
                        <label>Category</label>
                        <div class="dropdown" data-type="category" id="categoryDropdown">
                            <span class="dropdown-text">All Categories</span>
                            <div class="dropdown-menu" id="categoryMenu">
                                <div class="opt" data-id="">All Categories</div>
                            </div>
                        </div>
                    </div>

                    <div class="filter">
                        <label>Brand</label>
                        <div class="dropdown" data-type="brand" id="brandDropdown">
                            <span class="dropdown-text">All Brands</span>
                            <div class="dropdown-menu" id="brandMenu">
                                <div class="opt" data-id="">All Brands</div>
                            </div>
                        </div>
                    </div>
                </div>

                <table aria-label="Products table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category Name</th>
                            <th>Brand Name</th>
                            <th>Price</th>
                            <th style="text-align:right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <!-- rows come from script.js -->
                    </tbody>
                </table>

                <div id="pagination" style="margin-top:20px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;"></div>
            </div>
        </div>
    </div>

    <!-- Add / Edit Modal -->
    <div class="overlay" id="modalOverlay">
        <div class="modal" id="modalBox" style="width: 900px; height: auto; max-width:95%;">
            <h2 id="modalTitle">Edit Product</h2>
            <form id="modalForm" enctype="multipart/form-data">
                <input type="hidden" id="productId">

                <!-- Row 1: Name and Description -->
                <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px">
                        <label>Name</label>
                        <input id="pName" required style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                    </div>
                    <div style="flex:1; min-width:200px">
                        <label>Description</label>
                        <input id="pDescription" required style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                    </div>
                </div>

                <!-- Row 2: Model Year and Price -->
                <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px">
                        <label>Model Year</label>
                        <input id="pYear" type="number" min="1900" step="1" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                    </div>
                    <div style="flex:1; min-width:200px">
                        <label>Price (USD)</label>
                        <input id="pPrice" type="number" min="0" step="0.01" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                    </div>
                </div>

                <!-- Row 3: Brand and Category -->
                <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px">
                        <label>Brand</label>
                        <select id="pBrand" required style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                            <option value="">Select Brand</option>
                        </select>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label>Category</label>
                        <select id="pCategory" required style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border)">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>

                <!-- Row 4: Image -->
                <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px">
                        <label>Image</label>
                        <input id="pImg" type="file" multiple>
                    </div>
                </div>

                <div id="error-message" style="color: red;"></div>

                <div class="actions-row" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                    <button type="button" class="btn-muted" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveModal">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Modal -->
    <div class="overlay" id="viewOverlay">
        <div class="modal view-modal" style="width: 1000px; max-width:95%;">
            <h2 id="viewTitle" class="modal-title">Product Details</h2>

            <div class="view-content">
                <div class="image-section">
                    <img id="viewImg" src="" alt="Main Product Image" class="main-image">
                    <div id="viewThumbnails" class="thumbnails-container"></div>
                </div>

                <div class="details-section">
                    <div id="viewName" class="product-name"></div>
                    <div id="viewDescription" class="product-description"></div>
                    <div id="viewPrice" class="product-price"></div>
                    <div id="viewBrand" class="product-brand"></div>
                    <div id="viewCategory" class="product-category"></div>
                    <div id="viewYear" class="product-year"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-muted" id="closeView">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="overlay" id="deleteOverlay">
        <div class="modal" style="max-width:420px">
            <h2>Delete product?</h2>
            <div id="deleteMsg" style="color:var(--muted);margin-top:8px">Are you sure?</div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
                <button class="btn-muted" id="cancelDelete">Cancel</button>
                <button class="btn-primary" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>

        // --- Get JWT token from localStorage ---
        function authHeaders() {
            const token = localStorage.getItem("token");
            return {
                "Authorization": `Bearer ${token}`
            };
        }
        // AdminProducts.js - Fixed dropdown bug
        const API_BASE = 'https://localhost:7000/api/Products';
        const CAT_API = 'https://localhost:7000/api/Category';
        const BRAND_API = 'https://localhost:7000/api/Brands';
        const PAGE_SIZE = 10;

        let currentPage = 1;
        let totalPages = 1;
        let selectedCategoryId = '';
        let selectedBrandId = '';
        let categories = [];
        let brands = [];

        const tbody = document.getElementById('tbody');
        const paginationEl = document.getElementById('pagination');
        const searchInput = document.getElementById('searchInput');
        const loadingSpinner = document.getElementById('loadingSpinner');

        function qS(sel) { return document.querySelector(sel); }
        function qSA(sel) { return Array.from(document.querySelectorAll(sel)); }

        // --- Get JWT token from localStorage ---
        function authHeaders(formData = false) {
            const token = localStorage.getItem("token");
            return formData
                ? { "Authorization": `Bearer ${token}` } // No Content-Type
                : { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
        }


        // Build API URL (inline parameters style)
        function buildProductsUrl(searchTerm = '') {
            const cat = selectedCategoryId || '';
            const brand = selectedBrandId || '';
            const term = searchTerm || '';
            const url = `${API_BASE}?CategoryId=${encodeURIComponent(cat)}&BrandId=${encodeURIComponent(brand)}&SearchTerm=${encodeURIComponent(term)}&PageIndex=${encodeURIComponent(currentPage)}&PageSize=${PAGE_SIZE}`;
            return url;
        }

        // Escape HTML for safe rendering
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"'`=\/]/g, s => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
            }[s]));
        }

        // Show loading spinner
        function showLoading() {
            loadingSpinner.classList.add('show');
        }

        // Hide loading spinner
        function hideLoading() {
            loadingSpinner.classList.remove('show');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Render a single product row (Image | Name | Category | Brand | Price | Actions)
        function renderRow(p) {
            const tr = document.createElement('tr');
            const img = (Array.isArray(p.images) && p.images.length) ? p.images[0] : '';
            const priceText = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? `$${p.price}` : (p.price || '');
            tr.innerHTML = `
                    <td><img src="${escapeHtml(img)}" alt="${escapeHtml(p.name)}" style="width:60px;height:60px;border-radius:8px;object-fit:cover;border:1px solid #eee"></td>
                    <td>${escapeHtml(p.name)}</td>
                    <td>${escapeHtml(p.categoryName || '')}</td>
                    <td>${escapeHtml(p.brandName || '')}</td>
                    <td>${priceText}</td>
                    <td style="text-align:right">
                        <div class="actions">
                                         <button class="btn viewBtn" data-id="${escapeHtml(p.id)}">👁️</button>
<button class="btn editBtn" data-id="${escapeHtml(p.id)}">✏️</button>
<button class="btn delBtn" data-id="${escapeHtml(p.id)}">🗑️</button>
                        </div>
                    </td>

                  
                `;
            return tr;
        }

        // Render full table
        function renderTable(products, totalCount = 0) {
            tbody.innerHTML = '';
            if (!products || products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:gray;">No products found.</td></tr>`;
                renderPagination(0);
                return;
            }

            products.forEach(p => tbody.appendChild(renderRow(p)));

            // compute total pages
            totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));
            renderPagination(totalPages);
            attachRowButtons();
        }

        /* ---------- MODALS LOGIC ---------- */
        const overlayAddEdit = qS('#modalOverlay');
        const overlayView = qS('#viewOverlay');
        const overlayDelete = qS('#deleteOverlay');

        const modalTitle = qS('#modalTitle');
        const modalForm = qS('#modalForm');
        const productIdInput = qS('#productId');
        const pName = qS('#pName');
        const pYear = qS('#pYear');
        const pPrice = qS('#pPrice');
        const pImg = qS('#pImg');
        const PDescription = qS("#pDescription");
        const pCategory = qS('#pCategory');  // New: Category select
        const pBrand = qS('#pBrand');        // New: Brand select

        const viewTitle = qS('#viewTitle');
        const viewImg = qS('#viewImg');
        const viewName = qS('#viewName');
        const viewYear = qS('#viewYear');
        const viewPrice = qS('#viewPrice');
        const viewDescription = qS("#viewDescription");
        const viewCategory = qS("#viewCategory");
        const viewBrand = qS("#viewBrand");
        const viewThumbnails = qS('#viewThumbnails');  // Added for thumbnails

        // Buttons inside modals
        const cancelModalBtn = qS('#cancelModal');
        const saveModalBtn = qS('#saveModal');
        const closeViewBtn = qS('#closeView');
        const cancelDeleteBtn = qS('#cancelDelete');
        const confirmDeleteBtn = qS('#confirmDelete');

        let currentEditId = null;
        let deleteId = null;

        /* ---------- Add Product ---------- */
        qS('#addProductBtn').addEventListener('click', async () => {
            modalTitle.textContent = 'Add Product';
            modalForm.reset();
            productIdInput.value = '';
            currentEditId = null;
            // Populate category and brand dropdowns
            await populateModalDropdowns();
            overlayAddEdit.style.display = 'flex';
            setTimeout(() => overlayAddEdit.classList.add('show'), 10);
        });

        /* ---------- Edit Product ---------- */
        async function openEditModal(id) {
            modalTitle.textContent = 'Edit Product';
            currentEditId = id;

            // Populate category and brand dropdowns first
            await populateModalDropdowns();

            try {
                showLoading();
                const res = await fetch(`${API_BASE}/${id}`, {
                    headers: authHeaders()
                });
                if (!res.ok) throw new Error('Failed to fetch product');
                const p = await res.json();

                productIdInput.value = p.id;
                pName.value = p.name || '';
                pYear.value = p.modelYear || '';
                pPrice.value = p.price || '';
                PDescription.value = p.description || '';

                // Find and set category ID by name
                const selectedCat = categories.find(cat => cat.name === p.categoryName);
                pCategory.value = selectedCat ? selectedCat.id : '';

                // Find and set brand ID by name
                const selectedBrand = brands.find(brand => brand.name === p.brandName);
                pBrand.value = selectedBrand ? selectedBrand.id : '';

                // Do not set pImg.value (file input)
                overlayAddEdit.style.display = 'flex';
                setTimeout(() => overlayAddEdit.classList.add('show'), 10);

            } catch (err) {
                console.error('Error loading product:', err);
                showNotification('Failed to load product details.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Function to populate category and brand selects in modal
        async function populateModalDropdowns() {
            // Categories
            try {
                const catRes = await fetch(CAT_API, {
                    headers: authHeaders()
                });
                if (catRes.ok) {
                    categories = await catRes.json();  // Store globally
                    pCategory.innerHTML = '<option value="">Select Category</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        pCategory.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Failed to load categories:', err);
                pCategory.innerHTML = '<option value="">Select Category</option>';
                categories = [];  // Reset on error
            }

            // Brands
            try {
                const brandRes = await fetch(BRAND_API, {
                    headers: authHeaders()
                });
                if (brandRes.ok) {
                    brands = await brandRes.json();  // Store globally
                    pBrand.innerHTML = '<option value="">Select Brand</option>';
                    brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.id;
                        option.textContent = brand.name;
                        pBrand.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Failed to load brands:', err);
                pBrand.innerHTML = '<option value="">Select Brand</option>';
                brands = [];  // Reset on error
            }
        }

        /* ---------- Save (Add / Edit) ---------- */
        modalForm.addEventListener('submit', async e => {
            e.preventDefault();

            const data = {
                id: productIdInput.value,
                name: pName.value,
                description: PDescription.value,
                modelYear: Number(pYear.value),
                price: Number(pPrice.value),
                categoryId: pCategory.value,
                brandId: pBrand.value
            };

            try {
                showLoading();
                let url = API_BASE;
                let formData = new FormData();

                if (currentEditId) {
                    // For update (PUT): send id, name, description, modelYear, price, categoryId, brandId in query params; images in FormData body
                    formData.append('id', data.id);
                    formData.append('name', data.name);
                    formData.append('description', data.description);
                    formData.append('modelYear', data.modelYear.toString());
                    formData.append('price', data.price.toString());
                    formData.append('categoryId', data.categoryId.toString());
                    formData.append('brandId', data.brandId.toString());
                    if (pImg.files.length > 0) {
                        // Loop through each file and append individually
                        for (let i = 0; i < pImg.files.length; i++) {
                            formData.append('productImages', pImg.files[i]);
                        }
                    }
                    url = `${API_BASE}/${currentEditId}`;
                } else {
                    // For create (POST): all in FormData body
                    formData.append('name', data.name);
                    formData.append('description', data.description);
                    formData.append('modelYear', data.modelYear.toString());
                    formData.append('price', data.price.toString());
                    formData.append('categoryId', data.categoryId.toString());
                    formData.append('brandId', data.brandId.toString());
                    if (pImg.files.length > 0) {
                        // Loop through each file and append individually
                        for (let i = 0; i < pImg.files.length; i++) {
                            formData.append('productImages', pImg.files[i]);
                        }
                    }
                }
                console.log(formData);
                const res = await fetch(url, {
                    method: currentEditId ? 'PUT' : 'POST',
                    headers: authHeaders(),
                    body: formData
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                overlayAddEdit.classList.remove('show');
                setTimeout(() => {
                    overlayAddEdit.style.display = 'none';
                    modalForm.reset();
                }, 300);

                showNotification(currentEditId ? 'Product updated successfully!' : 'Product added successfully!');
                fetchAndRender();
            } catch (err) {
                console.error(err);
                document.getElementById("error-message").textContent = "Please enter all fields correctly. Error ";
                showNotification('Failed to save product.', 'error');
            } finally {
                hideLoading();
            }
        });

        /* ---------- View Product ---------- */
        async function openViewModal(id) {
            try {
                showLoading();
                const res = await fetch(`${API_BASE}/${id}`, {
                    headers: authHeaders()
                });
                if (!res.ok) throw new Error('Failed to fetch product');
                const p = await res.json();

                viewTitle.textContent = 'Product Details';
                viewName.textContent = p.name || '';
                viewYear.textContent = 'Model Year: ' + (p.modelYear || '-');
                viewDescription.textContent = 'Description: ' + (p.description || '');
                viewPrice.textContent = 'Price: $' + (p.price || 0);
                viewBrand.textContent = 'Brand: ' + (p.brandName || '');
                viewCategory.textContent = 'Category: ' + (p.categoryName || '');

                // Clear previous thumbnails
                viewThumbnails.innerHTML = '';

                // Set main image (first one, or a placeholder if none)
                const mainImageSrc = (p.images && p.images.length > 0) ? p.images[0] : '';
                viewImg.src = mainImageSrc;
                viewImg.alt = 'Main Product Image';

                // Add thumbnails for all images
                if (p.images && p.images.length > 0) {
                    p.images.forEach((imgSrc, index) => {
                        const thumb = document.createElement('img');
                        thumb.src = imgSrc;
                        thumb.alt = `Thumbnail ${index + 1}`;
                        thumb.className = 'thumbnail';  // Use CSS class
                        if (index === 0) thumb.classList.add('selected');  // Highlight first

                        // Click to set as main image
                        thumb.addEventListener('click', () => {
                            viewImg.src = imgSrc;
                            // Update selected state
                            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
                            thumb.classList.add('selected');
                        });

                        viewThumbnails.appendChild(thumb);
                    });
                }
                overlayView.style.display = 'flex';
                setTimeout(() => overlayView.classList.add('show'), 10);
            } catch (err) {
                console.error(err);
                showNotification('Failed to view product.', 'error');
            } finally {
                hideLoading();
            }
        }

        /* ---------- Delete Product ---------- */
        function openDeleteModal(id) {
            deleteId = id;
            qS('#deleteMsg').textContent = `Are you sure you want to delete this product?`;
            overlayDelete.style.display = 'flex';
            setTimeout(() => overlayDelete.classList.add('show'), 10);
        }

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!deleteId) return;
            try {
                showLoading();
                const res = await fetch(`${API_BASE}/${deleteId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                overlayDelete.classList.remove('show');
                setTimeout(() => {
                    overlayDelete.style.display = 'none';
                }, 300);
                showNotification('Product deleted successfully!');
                fetchAndRender();
            } catch (err) {
                console.error(err);
                showNotification('Failed to delete product.', 'error');
            } finally {
                hideLoading();
            }
        });

        /* ---------- Close / Cancel Buttons ---------- */
        cancelModalBtn.addEventListener('click', () => {
            overlayAddEdit.classList.remove('show');
            setTimeout(() => {
                overlayAddEdit.style.display = 'none';
                modalForm.reset();
            }, 300);
        });

        closeViewBtn.addEventListener('click', () => {
            overlayView.classList.remove('show');
            setTimeout(() => {
                overlayView.style.display = 'none';
            }, 300);
        });

        cancelDeleteBtn.addEventListener('click', () => {
            overlayDelete.classList.remove('show');
            setTimeout(() => {
                overlayDelete.style.display = 'none';
            }, 300);
        });

        // Click outside modal closes it
        [overlayAddEdit, overlayView, overlayDelete].forEach(ov => {
            ov.addEventListener('click', e => {
                if (e.target === ov) {
                    ov.classList.remove('show');
                    setTimeout(() => {
                        ov.style.display = 'none';
                        if (ov === overlayAddEdit) {
                            modalForm.reset();
                        }
                    }, 300);
                }
            });
        });

        // Render pagination controls
        function renderPagination(pages) {
            paginationEl.innerHTML = '';

            const createBtn = (label, cls, disabled = false, clickFn = null) => {
                const b = document.createElement('button');
                b.textContent = label;
                b.className = 'btn-pagination' + (cls ? ' ' + cls : '');
                if (disabled) { b.disabled = true; b.style.opacity = 0.6; }
                if (clickFn) b.addEventListener('click', clickFn);
                return b;
            };

            if (pages <= 1) return;

            // Prev
            paginationEl.appendChild(createBtn('◀️', '', currentPage <= 1, () => {
                if (currentPage > 1) { currentPage--; fetchAndRender(); }
            }));

            // Page numbers
            const gap = 1;
            const left = Math.max(1, currentPage - gap);
            const right = Math.min(pages, currentPage + gap);

            const addPage = i => {
                const btn = createBtn(i, i === currentPage ? 'active' : '', false, () => {
                    if (i !== currentPage) { currentPage = i; fetchAndRender(); }
                });
                paginationEl.appendChild(btn);
            };

            if (pages <= 7) {
                for (let i = 1; i <= pages; i++) addPage(i);
            } else {
                addPage(1);
                if (left > 2) paginationEl.appendChild(document.createTextNode('...'));
                for (let i = left; i <= right; i++) addPage(i);
                if (right < pages - 1) paginationEl.appendChild(document.createTextNode('...'));
                addPage(pages);
            }

            // Next
            paginationEl.appendChild(createBtn('▶️', '', currentPage >= pages, () => {
                if (currentPage < pages) { currentPage++; fetchAndRender(); }
            }));
        }

        // Fetch and render products
        async function fetchAndRender() {
            const term = (searchInput.value || '').trim();
            const url = buildProductsUrl(term);
            console.log('Fetching:', url);

            try {
                showLoading();
                const res = await fetch(url, { headers: authHeaders() });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const json = await res.json();

                // Adjusted for your backend response shape
                const products = json.result || [];
                const totalCount = json.totalCount || 0;
                currentPage = json.pageIndex || currentPage;
                renderTable(products, totalCount);
            } catch (err) {
                console.error('Fetch error', err);
                showNotification('Failed to load products.', 'error');
                renderTable([], 0);
            } finally {
                hideLoading();
            }
        }

        /* -------- Dropdowns (categories, brands) - FIXED VERSION ---------- */
        async function loadCategoriesAndBrands() {
            // Load categories
            try {
                const resC = await fetch(CAT_API, { headers: authHeaders() });
                if (!resC.ok) throw new Error('Failed to fetch categories');
                const cats = await resC.json();
                populateDropdown('#categoryDropdown', '#categoryMenu', cats, 'All Categories');
            } catch (err) {
                console.error('Error loading categories:', err);
                populateDropdown('#categoryDropdown', '#categoryMenu', [], 'All Categories');
            }

            // Load brands
            try {
                const resB = await fetch(BRAND_API, { headers: authHeaders() });
                if (!resB.ok) throw new Error('Failed to fetch brands');
                const brands = await resB.json();
                populateDropdown('#brandDropdown', '#brandMenu', brands, 'All Brands');
            } catch (err) {
                console.error('Error loading brands:', err);
                populateDropdown('#brandDropdown', '#brandMenu', [], 'All Brands');
            }

            wireDropdownBehaviour();
        }

        function populateDropdown(dropSelector, menuSelector, items = [], defaultLabel = 'All') {
            const drop = document.querySelector(dropSelector);
            const menu = document.querySelector(menuSelector);
            if (!drop || !menu) return;

            // Clear existing options except the default
            const defaultOpt = menu.querySelector('.opt[data-id=""]');
            menu.innerHTML = '';

            // Add default option
            const def = document.createElement('div');
            def.className = 'opt';
            def.dataset.id = '';
            def.textContent = defaultLabel;
            if (defaultLabel === (drop.querySelector('.dropdown-text').textContent || 'All Categories')) {
                def.classList.add('selected');
            }
            menu.appendChild(def);

            // Add items
            (items || []).forEach(it => {
                const d = document.createElement('div');
                d.className = 'opt';
                d.dataset.id = it.id ?? '';
                d.textContent = it.name ?? it.title ?? '—';
                menu.appendChild(d);
            });
        }

        function wireDropdownBehaviour() {
            const drops = qSA('.dropdown');

            drops.forEach(drop => {
                const menu = drop.querySelector('.dropdown-menu');
                const dropdownText = drop.querySelector('.dropdown-text');

                // Toggle dropdown on click
                drop.addEventListener('click', function (e) {
                    e.stopPropagation();

                    // Close all other dropdowns
                    qSA('.dropdown').forEach(d => {
                        if (d !== drop) d.classList.remove('open');
                    });

                    // Toggle current dropdown
                    drop.classList.toggle('open');
                });

                // Handle option selection
                const opts = menu.querySelectorAll('.opt');
                opts.forEach(opt => {
                    opt.addEventListener('click', function (e) {
                        e.stopPropagation();

                        const val = opt.textContent.trim();
                        const id = opt.dataset.id ?? '';

                        // Update dropdown text
                        dropdownText.textContent = val;

                        // Update selected class
                        opts.forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');

                        // Close dropdown
                        drop.classList.remove('open');

                        // Update filter state
                        const type = drop.dataset.type;
                        if (type === 'category') selectedCategoryId = id;
                        else if (type === 'brand') selectedBrandId = id;

                        // Reset to first page and fetch
                        currentPage = 1;
                        fetchAndRender();
                    });
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function () {
                qSA('.dropdown').forEach(d => d.classList.remove('open'));
            });
        }

        /* -------- Row Actions / Modals (placeholders) ---------- */
        function attachRowButtons() {
            qSA('.viewBtn').forEach(btn =>
                btn.addEventListener('click', () => openViewModal(btn.dataset.id))
            );
            qSA('.editBtn').forEach(btn =>
                btn.addEventListener('click', () => openEditModal(btn.dataset.id))
            );
            qSA('.delBtn').forEach(btn =>
                btn.addEventListener('click', () => openDeleteModal(btn.dataset.id))
            );
        }

        /* -------- Search Input (debounced) ---------- */
        let searchTimer = null;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                currentPage = 1;
                fetchAndRender();
            }, 300);
        });

        /* -------- Init ---------- */
        (async function init() {
            await loadCategoriesAndBrands();
            fetchAndRender();
        })();

        // Optional: toggle sidebar when pressing "m"
        document.addEventListener('keydown', (e) => {
            if (e.key === 'm' || e.key === 'M') {
                document.getElementById('sidebar').classList.toggle('collapsed');
            }
        });
    </script>
</body>
</html>